<!doctype html>
<html lang="en">
<style>
    .col-form-label {
    padding-top: calc(0.2rem + 1px);
    padding-bottom: calc(0.2rem + 1px);
    margin-bottom: 0;
    font-size: inherit;
    line-height: 1.5;
}
.close {
            float: right;
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1;
            color: #000;
            text-shadow: 0 1px 0 #fff;
            opacity: .5;
        }
        .close:not(:disabled):not(.disabled) {
            cursor: pointer;
        }
        button.close {
            padding: 0;
            background-color: transparent;
            border: 0;
            -webkit-appearance: none;
        }
</style>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <!-- <link rel="stylesheet" href="/resources/demos/style.css"> -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">


</head>
<body>
    
    <div class="col-md-12">
        <div class="x_panel">
            <div class="x_title">
                <h2>{{proyecto.year}}-{{proyecto.code}} : {{proyecto.nombre}}</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <a class="nav-link active" id="resultados-tab" data-toggle="tab" href="#resultados" role="tab" aria-controls="resultados" aria-selected="true">Resultados</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="cinterno-tab" data-toggle="tab" href="#cinterno" role="tab" aria-controls="cinterno" aria-selected="false">Costo Interno</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="cexterno-tab" data-toggle="tab" href="#cexterno" role="tab" aria-controls="cexterno" aria-selected="false">Costo Externo</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="facturacion-tab" data-toggle="tab" href="#facturacion" role="tab" aria-controls="facturacion" aria-selected="false">Facturación</a>
                </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="resultados" role="tabpanel" aria-labelledby="resultados-tab">
                    &nbsp;
                     <div class="row">
                                 <div class="col-3">
                                            <div class="row">
                                                <label class="col-form-label col-md-3 label-align" for="Estado"><b>Estado</b></label>
                                                <label class="col-form-label col-md-9 " for="nombre">{{proyecto.descripcion}}</label>
                                            </div>
                                            <div class="row">
                                                <label class="col-form-label col-md-3 label-align" for="cliente"><b>Cliente</b></label>
                                                <label class="col-form-label col-md-9 " for="nombre">{{proyecto.nomCliente}}</label>
                                            </div>
                                            <div class="row">
                                                    <label class="col-form-label col-md-3 label-align" for="tipologia"><b>Tipología</b></label> 
                                                    <label class="col-form-label col-md-9 " for="nombre">{{proyecto.tipologia}}</label>
                                            </div>
                                 </div>
                                 <div class="col-3">
                                     <div class="row">
                                                <label class="col-form-label col-md-4 label-align" for="director"><b>Director</b></label> 
                                                <label class="col-form-label col-md-8 " for="nombre">{{proyecto.nomDire}}</label>
                                            </div>
                                            <div class="row">
                                                <label class="col-form-label col-md-4 label-align" for="jdp"><b>Jefe Proyecto</b></label>
                                                <label class="col-form-label col-md-8 " for="nombre">{{proyecto.nomJefe}}</label>
                                            </div>
                                 </div>
                                 <div class="col-3">
                                    <div class="row">
                                                    <label class="col-form-label col-md-4 label-align" for="tipologia"><b>Superficie m<sup>2</sup></b></label>
                                                    <label class="col-form-label col-md-8 " for="nombre">{{proyecto.superficie_pre}}</label>
                                            </div>
                                            <div class="row">
                                                    <label class="col-form-label col-md-4 label-align" for="tarifa"><b>Tarifa UF/m<sup>2</sup></b></label>
                                                    <label class="col-form-label col-md-8 " for="nombre">{{proyecto.valor_metro_cuadrado}}</label>
                                            </div>
                                            <div class="row">
                                                    <label class="col-form-label col-md-4 label-align" for="numplanos"><b>Nº Planos</b></label>
                                                    <label class="col-form-label col-md-8 " for="nombre">{{proyecto.num_plano_estimado}}</label>
                                            </div>
                                 </div>
                            </div>
                </div>
                <div class="tab-pane fade" id="cinterno" role="tabpanel" aria-labelledby="cinterno-tab">
                   &nbsp;
                   <div class="row">
                       <div class="col-5">
                           <table id="example" class="table table-striped table-bordered" style="width:100%;padding-top: 0.3rem;padding-bottom: 0.3rem;">
                                <thead>
                                    <tr>
                                        <th style="padding-top: 0.3rem;padding-bottom: 0.3rem;">Colaborador</th>
                                        <th style="padding-top: 0.3rem;padding-bottom: 0.3rem;">Nº Horas</th>
                                        <th style="padding-top: 0.3rem;padding-bottom: 0.3rem;">Nº Horas Extras</th>
                                        <th style="padding-top: 0.3rem;padding-bottom: 0.3rem;">Total Horas</th>
                                        <th style="padding-top: 0.3rem;padding-bottom: 0.3rem;">Costo (UF)</th>
                                        <th style="padding-top: 0.3rem;padding-bottom: 0.3rem;">% Participación</th>
                                    </tr>
                                </thead>
                                 <tbody>
                                    {{#each colaboradores}}
                                        <tr>
                                            <td style="padding-top: 0.3rem;padding-bottom: 0.3rem;">{{nombre}}</td>
                                            <td style="padding-top: 0.3rem;padding-bottom: 0.3rem;">{{horas}}</td>
                                            <td style="padding-top: 0.3rem;padding-bottom: 0.3rem;">{{horasextras}}</td>
                                            <td style="padding-top: 0.3rem;padding-bottom: 0.3rem;">{{horastotal}}</td>
                                            <td style="padding-top: 0.3rem;padding-bottom: 0.3rem;">{{valorUF}}</td>
                                            <td style="padding-top: 0.3rem;padding-bottom: 0.3rem;">{{porcentaje}}</td>
                                        </tr>
                                    {{/each}}
                                
                                 </tbody>
                           </table>
                           <br>
                            <table id="example2" class="table table-striped table-bordered" style="width:100%;padding-top: 0.3rem;padding-bottom: 0.3rem;">
                                <thead>
                                    <tr>
                                        <th style="padding-top: 0.3rem;padding-bottom: 0.3rem;">HH</th>
                                        <th style="padding-top: 0.3rem;padding-bottom: 0.3rem;">Interno</th>
                                        <th style="padding-top: 0.3rem;padding-bottom: 0.3rem;">Costo(UF)</th>
                                       <!--  <th style="padding-top: 0.3rem;padding-bottom: 0.3rem;">Externo</th> -->
                                       <!--  <th style="padding-top: 0.3rem;padding-bottom: 0.3rem;">Totales</th> -->
                                    </tr>
                                </thead>
                                 <tbody>
                                    {{#each colaboradoresCentroCosto}}
                                        <tr>
                                            <td style="padding-top: 0.3rem;padding-bottom: 0.3rem;">{{nombre}}</td>
                                            <td style="padding-top: 0.3rem;padding-bottom: 0.3rem;">{{horas}}</td>
                                            <td style="padding-top: 0.3rem;padding-bottom: 0.3rem;">{{horasCosto}}</td>
                                            <!-- <td style="padding-top: 0.3rem;padding-bottom: 0.3rem;">{{externo}}</td> -->
                                            <!-- <td style="padding-top: 0.3rem;padding-bottom: 0.3rem;">{{total}}</td> -->
                                        </tr>
                                    {{/each}}
                                
                                 </tbody>
                           </table>
                       </div>
                       <div class="col-7">
                           <div class="row">
                                <div class="chart-container">
                                    <canvas id="myChart"></canvas>
                                </div>
                           </div>
                           <div class="row">
                               <div class="col-2">

                               </div>
                               <div class="col-4">
                                    <div class="chart-container">
                                        <canvas id="barChart"></canvas>
                                    </div>
                               </div>
                               <div class="col-4">
                                    <div class="chart-container">
                                        <canvas id="barChart2"></canvas>
                                    </div>
                               </div>
                                <div class="col-2">

                               </div>
                           </div>
                       </div>
                   </div>
                </div>
                <div class="tab-pane fade" id="cexterno" role="tabpanel" aria-labelledby="cexterno-tab">
                                        &nbsp;
                    <div class="row">
                            <div class="col-9">
                                <table class="table table-striped table-bordered" id="tablaCexternos">
                                <thead>
                                    <tr>
                                        <th>Proveedor</th>
                                        <th>Especialidad</th>
                                        <th>Orden de Compra</th>
                                        <th>Descripción</th>
                                        <th>num HH</th>
                                        <th>Costo ($)</th>
                                        <th>Costo (UF)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{#each cexternos}}
                                        <tr>
                                            <td>{{nNombre}}</td>
                                            <td>{{ccosto}}</td>
                                            <td>{{numoc}}</td>
                                            <td>{{descripcion}}</td>
                                            <td>{{numhh}}</td>
                                            <td>{{costo}}</td>
                                            <td>{{totPro}}</td>
                                        </tr>
                                    {{/each}}
                                </tbody>
                                </table>
                            </div>
                            <div class="col-3">
                                 &nbsp;
                                     <div class="row">
                                         <div class="col-11">
                                            <div class="chart-container">
                                                <canvas id="barChart3"></canvas>
                                            </div>
                                         </div>
                                     </div>
                                     <div class="row">
                                         <div class="col-11">
                                            <div class="chart-container">
                                                <canvas id="barChart4"></canvas>
                                            </div>
                                         </div>
                                     </div>
                            </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="facturacion" role="tabpanel" aria-labelledby="facturacion-tab">
                    &nbsp;
                    <table class="table table-hover" id="tablaFacturas">
                                <thead>
                                    <tr>
                                        <th>Solicitó</th>
                                        <th>Monto (UF)</th>
                                        <th>Valor (UF)</th>
                                        <th>% Facturación</th>
                                        <th>Hito</th>
                                        <th>Nº Documento</th>
                                        <th>Fecha Emisión</th>
                                        <th>Fecha Deposito</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{#each facturas}}
                                        <tr>
                                            <td>{{Nombre}}</td>
                                            <td>{{monto_a_facturar}}</td>
                                            <td>{{uf_valor}}</td>
                                            <td>{{porc_ppto}}</td>
                                            <td>{{tipoCobro}}</td>
                                            <td>{{num_factura}}</td>
                                            <td>{{fecha_factura}}</td>
                                            <td>{{fecha_pago}}</td>
                                            <td>{{estadoFac}}</td>
                                        </tr>
                                    {{/each}}
                                </tbody>
                            </table>
                </div>
                </div>
            </div>
        </div>
    </div>

</body>
 
 <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

 <script src="../../../template/vendors/datatables.net/js/jquery.dataTables.min.js"></script>
 <script src="../../../template/vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script> 
 <script src="../../../template/vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>

<script>
     $('#example').DataTable({
          "dom": "<'row'<'col-sm-12 col-md-6'><'col-sm-12 col-md-6'>>" +
                "<'row'<'col-sm-12'tr>>" +
                "<'row'<'col-sm-12 col-md-5'><'col-sm-12 col-md-7'p>>",
                columnDefs: [
                        { className: 'text-center', targets: [0,1,2,3,4,5] },
                    ],
        language: {
          "decimal": "",
          "emptyTable": "No hay información",
          "info": "Mostrando _START_ a _END_ de _TOTAL_ Entradas",
          "infoEmpty": "Mostrando 0 to 0 of 0 Entradas",
          "infoFiltered": "(Filtrado de _MAX_ total entradas)",
          "infoPostFix": "",
          "thousands": ",",
          "lengthMenu": "Mostrar _MENU_ Entradas",
          "loadingRecords": "Cargando...",
          "processing": "Procesando...",
          "search": "Buscar:",
          "zeroRecords": "Sin resultados encontrados",
          "paginate": {
            "first": "Primero",
            "last": "Ultimo",
            "next": "Siguiente",
            "previous": "Anterior"
          }
        }
      });
     var dataTable2 = $('#example2').DataTable({
          "dom": "<'row'<'col-sm-12 col-md-6'><'col-sm-12 col-md-6'>>" +
                "<'row'<'col-sm-12'tr>>" +
                "<'row'<'col-sm-12 col-md-5'><'col-sm-12 col-md-7'p>>",
        columnDefs: [
                        { className: 'text-center', targets: [0,1,2] },
                    ],
        language: {
          "decimal": "",
          "emptyTable": "No hay información",
          "info": "Mostrando _START_ a _END_ de _TOTAL_ Entradas",
          "infoEmpty": "Mostrando 0 to 0 of 0 Entradas",
          "infoFiltered": "(Filtrado de _MAX_ total entradas)",
          "infoPostFix": "",
          "thousands": ",",
          "lengthMenu": "Mostrar _MENU_ Entradas",
          "loadingRecords": "Cargando...",
          "processing": "Procesando...",
          "search": "Buscar:",
          "zeroRecords": "Sin resultados encontrados",
          "paginate": {
            "first": "Primero",
            "last": "Ultimo",
            "next": "Siguiente",
            "previous": "Anterior"
          }
        }
      });

      $('#tablaFacturas').DataTable({
          "dom": "<'row'<'col-sm-12 col-md-6'f><'col-sm-12 col-md-6'l>>" +
                "<'row'<'col-sm-12'tr>>" +
                "<'row'<'col-sm-12 col-md-5'><'col-sm-12 col-md-7'p>>",
        language: {
          "decimal": "",
          "emptyTable": "No hay información",
          "info": "Mostrando _START_ a _END_ de _TOTAL_ Entradas",
          "infoEmpty": "Mostrando 0 to 0 of 0 Entradas",
          "infoFiltered": "(Filtrado de _MAX_ total entradas)",
          "infoPostFix": "",
          "thousands": ",",
          "lengthMenu": "Mostrar _MENU_ Entradas",
          "loadingRecords": "Cargando...",
          "processing": "Procesando...",
          "search": "Buscar:",
          "zeroRecords": "Sin resultados encontrados",
          "paginate": {
            "first": "Primero",
            "last": "Ultimo",
            "next": "Siguiente",
            "previous": "Anterior"
          }
        }
      });

     var dataTable3 =  $('#tablaCexternos').DataTable({
          "dom": "<'row'<'col-sm-12 col-md-6'f><'col-sm-12 col-md-6'l>>" +
                "<'row'<'col-sm-12'tr>>" +
                "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
        language: {
          "decimal": "",
          "emptyTable": "No hay información",
          "info": "Mostrando _START_ a _END_ de _TOTAL_ Entradas",
          "infoEmpty": "Mostrando 0 to 0 of 0 Entradas",
          "infoFiltered": "(Filtrado de _MAX_ total entradas)",
          "infoPostFix": "",
          "thousands": ",",
          "lengthMenu": "Mostrar _MENU_ Entradas",
          "loadingRecords": "Cargando...",
          "processing": "Procesando...",
          "search": "Buscar:",
          "zeroRecords": "Sin resultados encontrados",
          "paginate": {
            "first": "Primero",
            "last": "Ultimo",
            "next": "Siguiente",
            "previous": "Anterior"
          }
        }
      });
             $('#tablaCinternos').DataTable({
          "dom": "<'row'<'col-sm-12 col-md-6'f><'col-sm-12 col-md-6'l>>" +
                "<'row'<'col-sm-12'tr>>" +
                "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
        language: {
          "decimal": "",
          "emptyTable": "No hay información",
          "info": "Mostrando _START_ a _END_ de _TOTAL_ Entradas",
          "infoEmpty": "Mostrando 0 to 0 of 0 Entradas",
          "infoFiltered": "(Filtrado de _MAX_ total entradas)",
          "infoPostFix": "",
          "thousands": ",",
          "lengthMenu": "Mostrar _MENU_ Entradas",
          "loadingRecords": "Cargando...",
          "processing": "Procesando...",
          "search": "Buscar:",
          "zeroRecords": "Sin resultados encontrados",
          "paginate": {
            "first": "Primero",
            "last": "Ultimo",
            "next": "Siguiente",
            "previous": "Anterior"
          }
        }
      });

$(document).ready(function(){
    
    $.ajax({
        url: "horas/{{proyecto.id}}",
        dataType: 'json',
        contentType: "application/json; charset=utf-8",
        method: "GET",
        success: function(data) {
            let fechas = [];
            let dataset = [];
            let labelsCentros = [];
            let labelsColor = [];
            let coloresCentro = [];
            let estado = false;
            for (var i in data) {
                fechas.push(data[i].fecha);
                for (var i2 in data[i].centro)
                {
                    let containsCentro = !!dataset.find(centro => {return centro.label === data[i].centro[i2].centro});
                    if (containsCentro === false)
                    {
                        dataset.push({
                            label : data[i].centro[i2].centro,
                            borderWidth: 1,
                            data : [],
                            backgroundColor:data[i].centro[i2].color
                        });
                        labelsCentros.push(data[i].centro[i2].centro);
                        labelsColor.push(data[i].centro[i2].color);

                        
                    }
                }
                if(estado === false)
                        {
                            coloresCentro = data[i].centroColores;
                            estado = true;
                        }

            }

            for (let c in dataset)
            {
                for (var i in data) {
                    let valor = 0;
                     for (var i2 in data[i].centro){
                         let containsCentro = !!data[i].centro.find(centro => {return centro.centro === dataset[c].label});

                          if (containsCentro === true)
                          {
                              let centro = data[i].centro.find(centro => {return centro.centro === dataset[c].label});
                              valor = centro.horas;
                          }
                     }
                    dataset[c].data.push(valor);
                }
            }
             
            //console.log(dataset);

            var mostrar = $("#myChart");
            var mostrar2 = $("#barChart");
            var mostrar3 = $("#barChart2");

            var mostrar4 = $("#barChart3");
            var mostrar5 = $("#barChart4");
 
                const chart = new Chart(mostrar, {
                type: 'bar',
                data: {
                    labels: fechas,
                    datasets: dataset
                },
                options: {
                            plugins: {
                            title: {
                                display: true,
                                text: 'Distribucion Esfuerzo Por Mes'
                            },
                            },
                            responsive: true,
                            scales: {
                            x: {
                                stacked: true,
                            },
                            y: {
                                stacked: true
                            }
                            }
                        }
                });
                       
           let valoresHH = [];
           let valoresHHCosto = [];

            for (let centros in labelsCentros)
            {
                dataTable2.rows().iterator('row', function(context, index){
                var node = $(this.row(index).node()); 
                    //console.log(node.context.children[0].innerText);
                    if (node.context.children[0].innerText != "TOTALES")
                    {
                       // console.log(labelsCentros[centros]);
                       // console.log(node.context.children[0].innerText);
                        if (labelsCentros[centros] == node.context.children[0].innerText)
                        {
                            valoresHH.push(node.context.children[1].innerText);
                            valoresHHCosto.push(node.context.children[2].innerText);
                        }
                    }
                });
            }

            var data = {
                        labels: labelsCentros,
                        datasets: [
                            {
                                fill: true,
                                backgroundColor: labelsColor,
                                data: valoresHH
                            }
                        ]
                    };
            var dataCosto = {
                        labels: labelsCentros,
                        datasets: [
                            {
                                fill: true,
                                backgroundColor: labelsColor,
                                data: valoresHHCosto
                            }
                        ]
                    };

            const chart2 = new Chart(mostrar2, {
                type: 'pie',
                data: data,
                options: {
                            plugins: {
                            title: {
                                display: true,
                                text: 'Distribucion TIEMPO (HH)'
                            },
                            },
                            responsive: true
                        }
                });

            const chart3 = new Chart(mostrar3, {
                type: 'pie',
                data: dataCosto,
                options: {
                            plugins: {
                            title: {
                                display: true,
                                text: 'Distribucion COSTOS (UF)'
                            },
                            },
                            responsive: true
                        }
                });


          //  console.log(labelsCentros);
          // Recorrer la tabla de costos externos.

          let cExternos= [];

           dataTable3.rows().iterator('row', function(context, index){
                var node = $(this.row(index).node());

                const centroCostoExterno = !!cExternos.find(centro => {return centro.nombre === node.context.children[1].innerText });
                if (centroCostoExterno === false)
                {
                    cExternos.push({
                                        nombre :node.context.children[1].innerText ,
                                        color : "",
                                        horas : node.context.children[4].innerText,
                                        costo : node.context.children[6].innerText
                                });

                    const centroCostoExternoValor = cExternos.find(centro => {return centro.nombre === node.context.children[1].innerText });
                }
                else
                {
                    const centroCostoExternoValor = cExternos.find(centro => {return centro.nombre === node.context.children[1].innerText });

                    centroCostoExternoValor.horas =  parseFloat(centroCostoExternoValor.horas) +  parseFloat(node.context.children[4].innerText);
                    centroCostoExternoValor.costo =  parseFloat(centroCostoExternoValor.costo) +  parseFloat(node.context.children[6].innerText);
                }

               // console.log(node.context.children[4].innerText);
           });

        //coloresCentro
        let labelsCentrosExterno = [];
        let labelsColorExterno = [];
        let labelsHHExterno = [];
        let labelsCostoExterno = [];

         for (let centros in cExternos)
         {
             for (let centro in coloresCentro)
             {
                 if (cExternos[centros].nombre === coloresCentro[centro].centroCosto)
                 {
                    cExternos[centros].color =  coloresCentro[centro].color;

                    
                 }
             }
             labelsCentrosExterno.push(cExternos[centros].nombre );
             labelsColorExterno.push(cExternos[centros].color );
             labelsHHExterno.push(cExternos[centros].horas );
             labelsCostoExterno.push(cExternos[centros].costo );
         }

         var dataCostoExternoHH = {
                        labels: labelsCentrosExterno,
                        datasets: [
                            {
                                fill: true,
                                backgroundColor: labelsColorExterno,
                                data: labelsHHExterno
                            }
                        ]
                    };

        var dataCostoExternoCosto = {
                        labels: labelsCentrosExterno,
                        datasets: [
                            {
                                fill: true,
                                backgroundColor: labelsColorExterno,
                                data: labelsCostoExterno
                            }
                        ]
                    };


           const chart4 = new Chart(mostrar4, {
                type: 'pie',
                data: dataCostoExternoHH,
                options: {
                            plugins: {
                            title: {
                                display: true,
                                text: 'Distribucion HORAS (HH)'
                            },
                            },
                            responsive: true
                        }
                });

                const chart5 = new Chart(mostrar5, {
                type: 'pie',
                data: dataCostoExternoCosto,
                options: {
                            plugins: {
                            title: {
                                display: true,
                                text: 'Distribucion COSTOS (UF)'
                            },
                            },
                            responsive: true
                        }
                });


        },
        error: function(data) {
            
        }
    });
});

</script>

</html>