  <head>
    <style>
        table {
            table-layout: fixed;
        }

        table td {
            word-wrap: break-word;
            max-width: 400%;
        }

        #grid td {
            white-space: inherit;
        }
         .headerToolbar {
            background-color: #fed300;

        }
        .close {
            float: right;
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1;
            color: #000;
            text-shadow: 0 1px 0 #fff;
            opacity: .5;
        }
        .close:not(:disabled):not(.disabled) {
            cursor: pointer;
        }
        button.close {
            padding: 0;
            background-color: transparent;
            border: 0;
            -webkit-appearance: none;
        }
          .dataTables_filter{
	    position: relative;
  		float: left;
            }
            .dataTables_length{
                    position: relative;
                    float: right;
            }
    </style>
</head>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">

  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.1/js/tempusdominus-bootstrap-4.min.js"></script>

<div class="col-md-6">
    <div class="x_panel">
        <div class="x_title">
            <h2>Ingresar Orden de Compra</h2>
            <div class="clearfix"></div>
        </div>
        <div class="x_content">
            <form id="ingresoOC" name="ingresoOC" data-parsley-validate class="form-horizontal form-label-left" action="/solicitudes/addOC" method="POST">

            
            <div class="form-group row">
                <label class="col-form-label col-md-3 col-sm-3 label-align"	for="Emisor"> <b>Emisor:</b></label>
                    <div class="col-md-6 col-sm-6">
                        <select class="select2_single form-control" tabindex="1" name="emisor" id="emisor" onchange="cargaEmisorOC(this.value);">
                            <option value="">Seleccione</option>
                            {{#each empresas}}
                                <option value="{{id}}">{{razonsocial}}</option>
                            {{/each}}
                    </select>
                </div>
            </div>
            <div class="form-group row" style="visibility: hidden; display:none;">
                <label class="col-form-label col-md-3 col-sm-3 label-align"	for="Emisor"><b>Razon Social:</b></label>
                    <div class="col-md-6 col-sm-6">
                        <input type="text" id="razonsocial" name="razonsocial"  class="form-control" readonly>
                    </div>
            </div>
            <div class="form-group row" style="visibility: hidden; display:none;">
                <label class="col-form-label col-md-3 col-sm-3 label-align"	for="Emisor"><b>Rut:</b></label>
                    <div class="col-md-6 col-sm-6">
                        <input type="text" id="rut" name="rut"  class="form-control" readonly>
                    </div>
            </div>
            <div class="form-group row">
                <label class="col-form-label col-md-3 col-sm-3 label-align"	for="Emisor"><b>Tipo :</b></label>
                    <div class="col-md-6 col-sm-6">
                        <select class="select2_single form-control" tabindex="1" name="id_tipo_proveedor" id="id_tipo_proveedor" onchange="cargaTipoProveedor(this.value);">
                            <option value="">Seleccione</option>
                            <option value="1">Proveedor Interno</option>
                            <option value="2">Proveedor Externo</option>
                            <option value="3">Compra</option>
                        </select>
                    </div>
            </div>
            <div class="form-group row" id="razonsocialProv" style="visibility: hidden; display:none;">
                <label class="col-form-label col-md-3 col-sm-3 label-align"	for="rnombrepro" id="rnombrepro"><b>#####:</b></label>
                    <div class="col-md-6 col-sm-6">
                        <select class="select2_single form-control" tabindex="1" name="razonsocialpro" id="razonsocialpro" onchange="cargaRutProovedor(this.value);">

                        </select>
                    </div>
                    <div class="col-md-1 col-sm-1">
                        <button type="button" class="btn btn-success btn-sm"><a type="button" style="color: white;">+</a></button>
                    </div>
            </div>
            <div class="form-group row" style="visibility: hidden; display:none;">
                <label class="col-form-label col-md-3 col-sm-3 label-align"	for="Emisor"><b>Rut:</b></label>
                    <div class="col-md-6 col-sm-6">
                        <input type="text" id="rutproveedor" name="rutproveedor"  class="form-control" readonly>
                        <input type="hidden" id="idproveedor" name="rutproidproveedorveedor"  class="form-control">
                    </div>
            </div>
            <div class="form-group row">
                <label class="col-form-label col-md-3 col-sm-3 label-align"	for="Emisor"><b>Solicitante:</b></label>
                    <div class="col-md-6 col-sm-6">
                        <select class="select2_single form-control" tabindex="1" name="id_solicitante" id="id_solicitante">
                            <option value="">Seleccione</option>
                            {{#each solicitantes}}
                                <option value="{{idUsuario}}">{{Nombre}}</option>
                            {{/each}}
                    </select>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-form-label col-md-3 col-sm-3 label-align"	for="Emisor"><b>Director:</b></label>
                    <div class="col-md-6 col-sm-6">
                        <select class="select2_single form-control" tabindex="1" name="id_director" id="id_director">
                            <option value="">Seleccione</option>
                            {{#each directores}}
                                <option value="{{idUsuario}}">{{Nombre}}</option>
                            {{/each}}
                    </select>
                </div>
            </div>
             <div class="form-group row">
                <label class="col-form-label col-md-3 col-sm-3 label-align"	for="Emisor"><b>Centro Costo:</b></label>
                    <div class="col-md-6 col-sm-6">
                        <select class="select2_single form-control" tabindex="1" name="id_centro_costo" id="id_centro_costo" onchange="cargaAreaNegocio(this.value);">
                            <option value="">Seleccione</option>
                            {{#each centroCostos}}
                                <option value="{{id}}">{{centroCosto}}</option>
                            {{/each}}
                    </select>
                </div>
            </div>
            <div class="form-group row" id="areanegocio1" style="visibility: hidden; display:none;">
                <label class="col-form-label col-md-3 col-sm-3 label-align"	for="Emisor"><b>Proyecto</b></label>
                    <div class="col-md-6 col-sm-6">
                        <select class="select2_single form-control" tabindex="1" name="id_proyecto" id="id_proyecto">
                            <option value="">Seleccione</option>
                            {{#each proyectos}}
                                <option value="{{id}}">{{year}}-{{code}} : {{nombre}} </option>
                            {{/each}}
                         </select>
                </div>
            </div>
            <div class="form-group row" id="areanegocio2" style="visibility: hidden; display:none;">
                <label class="col-form-label col-md-3 col-sm-3 label-align"	for="Emisor"><b>Etapa</b></label>
                    <div class="col-md-6 col-sm-6">
                        <select class="select2_single form-control" tabindex="1" name="id_etapa" id="id_etapa">
                            <option value="">Seleccione</option>
                            {{#each etapas}}
                                <option value="{{id}}">{{descripcion}} </option>
                            {{/each}}
                        </select>
                </div>
            </div>
             <div class="form-group row" >
                <div class="col-md-9 col-sm-9"></div>
                <div class="col-md-1 col-sm-1">
                    <button type="button" class="btn btn-success btn-sm" data-toggle="modal" data-target="#requerimiento">Agregar</button>
                </div>
             </div>
            
             {{#if requerimientos }}
            <div id="tablaInformacion">
               <table class="table table-hover" id="tableRequerimiento">
                    <thead>
                        <tr>
                            <th>Cantidad</th>
                            <th>Descripción</th>
                            <th>Precio Unitario</th>
                            <th>Moneda</th>
                            <th>Monto</th>
                            <th>Monto en $</th>
                            <th> </th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each requerimientos}}
                             <tr>
                                <td>{{cantidad}}</td>
                                <td>{{descripcion}}</td>
                                <td>{{precio_unitario}}</td>
                                <td>{{mon}}</td>
                                <td></td>
                                <td></td>
                                <td>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="EliminarRegistro({{id}});">Eliminar</button>
                                </td>
                            </tr>
                        {{/each}}
                        <tfoot>
                            <th style="border-bottom-width: 0px;">
                                <td style="border-bottom-width: 0px;"></td>
                                <td style="border-bottom-width: 0px;">
                                    <button type="button" class="btn btn-success btn-sm" onclick="ingresarOC();">Ingresar</button>
                                </td>
                            </th>
                            
                        </tfoot>
                    </tbody>
                </table>
            </div>
             {{/if}}          
 
            <div class="modal fade" id="requerimiento" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLongTitle">Requerimiento</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group row">
                                <label class="col-form-label col-md-3 col-sm-3 label-align"	for="Emisor"><b>Cantidad</b></label>
                                    <div class="col-md-8 col-sm-8">
                                        <input type="text" id="cantidad" name="cantidad"  class="form-control">
                                    </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-form-label col-md-3 col-sm-3 label-align"	for="Emisor"><b>Descripción</b></label>
                                    <div class="col-md-8 col-sm-8">
                                        <textarea id="descripcion" name="descripcion"  class="form-control"></textarea>
                                    </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-form-label col-md-3 col-sm-3 label-align"	for="Emisor"><b>Precio Unitario</b></label>
                                    <div class="col-md-8 col-sm-8">
                                        <input type="text" id="punitario" name="punitario"  class="form-control">
                                    </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-form-label col-md-3 col-sm-3 label-align"	for="Emisor"><b>Moneda</b></label>
                                    <div class="col-md-8 col-sm-8">
                                       <select class="select2_single form-control" tabindex="1" name="id_moneda" id="id_moneda">
                                            <option value="">Seleccione</option>
                                            {{#each monedas}}
                                                <option value="{{id_moneda}}">{{descripcion}} </option>
                                            {{/each}}
                                        </select>
                                    </div>
                            </div>
                             <div class="form-group row">
                                <label class="col-form-label col-md-3 col-sm-3 label-align"	for="Emisor"><b>Tipo Cambio</b></label>
                                    <div class="col-md-8 col-sm-8">
                                        <input type="text" id="tipocambio" name="tipocambio"  class="form-control">
                                    </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-success" data-dismiss="modal" onclick="cargaDetalle()">Ingresar</button>
                         </div>
                    </div>
                </div>
            </div>
            </form>
        </div>
    </div>
</div>
<div class="col-md-6">
    <div class="x_panel">
		<div class="x_title">
               <h2>Listado </h2> 
		    <div class="clearfix"></div>
		</div>
        <div class="x_content">
                
        </div>  
    </div>
</div>

<!-- Option 1: jQuery and Bootstrap Bundle (includes Popper) -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>-->

<script src="../../../template/vendors/datatables.net/js/jquery.dataTables.min.js"></script>
<script src="../../../template/vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script> 
<script src="../../../template/vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>



<script>
    function cargaEmisorOC(valor)
    {
        if (valor !== "")
        {
                $.ajax({
                                    async: false,
                                    type : 'POST', 
                                    url	 : "/solicitudes/buscaEmpresa", 
                                    data : "id="+valor,
                                    success : function (resultado) 
                                        { 
                                            // $("#idTarea").html(resultado);
                                            //alert("Buscar informacion");
                                            $("#razonsocial").val(resultado.razonsocial);
                                            $("#rut").val(resultado.rut);
                                        } 
                                });
        }
        else
        {
            $("#razonsocial").val("");
            $("#rut").val("");
        }
    }

    function cargaTipoProveedor(valor)
    {
        if (valor !== "")
        {
            switch(valor)
            {
                case 1:
                case "1":
                    $("#rnombrepro").html("<b>Nombre</b>");
                    $("#razonsocialProv").css("visibility", "visible");
                    $("#razonsocialProv").show();
                break;
                case 2:
                case "2":
                    $("#rnombrepro").html("<b>Razon Social</b>");
                    $("#razonsocialProv").css("visibility", "visible");
                    $("#razonsocialProv").show();
                break;
                case 3:
                case "3":
                    $("#rnombrepro").html("<b>Razon Social</b>");
                    $("#razonsocialProv").css("visibility", "hidden");
                    $("#razonsocialProv").hide();
                break;
            }

            // buscar información para cargar el listado. 
             $.ajax({
                                    async: false,
                                    type : 'POST', 
                                    url	 : "/solicitudes/buscaProveedor", 
                                    data : "id="+valor,
                                    success : function (resultado) 
                                        { 
                                            $("#razonsocialpro").html(resultado);
                                        } 
                                });


        }
    }

    function cargaRutProovedor(valor)
    {
        if (valor !== "")
        {

            // buscar información para cargar el listado. 
             $.ajax({
                                    async: false,
                                    type : 'POST', 
                                    url	 : "/solicitudes/buscaProveedorRut", 
                                    data : "id="+valor,
                                    success : function (resultado) 
                                        { 
                                            $("#rutproveedor").val(resultado.rut);
                                        } 
                                });


        }

    }

    function cargaAreaNegocio( valor)
    {
    if (valor !== "")
        {

            // buscar información para cargar el listado. 
             $.ajax({
                                    async: false,
                                    type : 'POST', 
                                    url	 : "/solicitudes/buscaCentroCosto", 
                                    data : "id="+valor,
                                    success : function (resultado) 
                                        { 
                                            switch(resultado.areanegocio)
                                            {
                                                case "1":
                                                case 1:
                                                    $("#areanegocio1").css("visibility", "visible");
                                                    $("#areanegocio2").css("visibility", "visible");
                                                    $("#areanegocio1").show();
                                                    $("#areanegocio2").show();
                                                break;
                                                case "2":
                                                case 2:
                                                case "3":
                                                case 3:
                                                    $("#areanegocio1").css("visibility", "hidden");
                                                    $("#areanegocio2").css("visibility", "hidden");
                                                    $("#areanegocio1").hide();
                                                    $("#areanegocio2").hide();
                                                break;
                                            }
                                        } 
                                });


        }


    }

    function cargaDetalle()
    {
        // cargar la informacion del detalle. 

        let cantidad        = $("#cantidad").val();
        let descripcion     = $("#descripcion").val();
        let precioUnitario  = $("#punitario").val();
        let moneda          = $("#id_moneda").val();
        let tipocambio      = $("#tipocambio").val();

        let informacion = {
            cantidad ,
            descripcion,
            precioUnitario,
            moneda,
            tipocambio
        };
        

        $.ajax({
              type: 'post',
              url: '/solicitudes/ordecompradetalle',
              data: informacion,
              dataType: 'text'
               })
              .done(function (data) {
                $('#tablaInformacion').html(data);
              });
     
     $('#requerimiento').modal('toggle'); //Me muestra el formulario si esta oculto

        

    }
    
    function EliminarRegistro (id)
    {
        // cargar la informacion del detalle. 
        let informacion = {  id  };
        

        $.ajax({
              type: 'post',
              url: '/solicitudes/ordecompradetalleEliminar',
              data: informacion,
              dataType: 'text'
               })
              .done(function (data) {
                $('#tablaInformacion').html(data);
              });
    
    }

    function ingresarOC()
    {
        let id_empresa         = $("#emisor").val();
        let id_tipo_proveedor  = $("#id_tipo_proveedor").val();
        let id_solicitante     = $("#id_solicitante").val();
        let id_director        = $("#id_director").val();
        let id_centro_costo    = $("#id_centro_costo").val();
        let id_proyecto         = $("#id_proyecto").val();
        let id_etapa            = $("#id_etapa").val();
        let razonsocialpro      = $("#razonsocialpro").val();
        //__________________________________________________

        // 1 y 2 proveedores interno o externo 
        if (id_tipo_proveedor == 1 || id_tipo_proveedor == 2)
        {
            
            
            if (razonsocialpro == "")
            {
                console.log("tipo razonsocialpro");
                return false;
            }
        }
        else if (id_tipo_proveedor == 3)
        {

        }
        else
        {
            console.log("tipo proveedor");
            return false;
        }

        //  validar centro de costo 
        if (id_centro_costo == 2 || id_centro_costo == 3 || id_centro_costo == 4 || 
            id_centro_costo == 5 || id_centro_costo == 6 || id_centro_costo == 8)
        {
            if (id_proyecto == "" || id_etapa == "")
            {
                console.log("centro costo");
                return false;
            }
        }
        // crear el objeto


        let informacion = {
            id_empresa,
            id_tipo_proveedor,
            id_solicitante,
            id_director,
            id_centro_costo,
            razonsocialpro : razonsocialpro,
            id_proyecto : id_proyecto,
            id_etapa : id_etapa
        };

         $("#ingresoOC").submit();

    }
</script>

